<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Easy Imgur Uploader</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
	<link rel="stylesheet" href="css/dropzone.css">
  </head>

  <body>
  
  
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
	<a href="https://github.com/Fluffy9/Easy-Imgur-Upload"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>
      <div class="container">
        <a class="navbar-brand" href="#">Easy Imgur Uploader</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <!--<ul class="navbar-nav ml-auto">
            <li class="nav-item active">
              <a class="nav-link" href="#">Home
                <span class="sr-only">(current)</span>
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Contact</a>
            </li>
          </ul>-->
        </div>
      </div>
    </nav>

	<div class="container" style="padding-top:20px; text-align:center; margin-bottom:100px;">
		<h1>Upload Imgur Albums!</h1>
		<p style="">Do you have a lot of images? Are you tired of Imgur's drag and drop interface? Do you want to ensure your images are in the same order as they are in your folder? (Plus more features planned) Well now you can! This website is free, confidential, and everything runs client side.</p>
		<div class="row">
			<div class="col-sm-4" style="text-align:left;">
				<h3>Load your Client ID</h3>
					<p>Don't have one? <a href="https://api.imgur.com/oauth2/addclient">Click here!</a> They are free and you can upload approximately 1250 images a day</p>
				<div id="LoadID">
					<div class="form-group">
					  <label for="clientid">Client ID:</label>
					  <input type="text" class="form-control" id="clientid">
					  <button onclick="Authorize()" class="btn btn-default">Authorize</button>
					</div>
				</div>
				<div id="LoadCheck" class="check_mark">
				  <div class="sa-icon sa-success animate">
					<span class="sa-line sa-tip animateSuccessTip"></span>
					<span class="sa-line sa-long animateSuccessLong"></span>
					<div class="sa-placeholder"></div>
					<div class="sa-fix"></div>
				  </div>
				</div>
			</div>
			<div class="col-sm-4">
				<h3>Upload Your Images</h3>
				<p>Upload a .zip file of your images</p>
				<div id="dropzone" style="color:black; text-align:center"><span>Drag files here or click to upload</span></div>
				<div id="FileCheck" class="check_mark">
				  <div class="sa-icon sa-success animate">
					<span class="sa-line sa-tip animateSuccessTip"></span>
					<span class="sa-line sa-long animateSuccessLong"></span>
					<div class="sa-placeholder"></div>
					<div class="sa-fix"></div>
				  </div>
				</div>
			</div>
			<div class="col-sm-4">
				<h3>Choose your options</h3>
				<p>In your imgur account, create a new album. Enter the album id in the box below</p>
				<div id="ChooseOptions" class="form-group">
				</br>
				  <label for="albumid">Album ID:</label>
				  <input type="text" class="form-control" id="albumid">
				  <button  id="Submit" type="submit" class="btn btn-default">Upload to Imgur!</button>
				</div>
				<div id="SubmitCheck" class="check_mark">
				  <div class="sa-icon sa-success animate">
					<span class="sa-line sa-tip animateSuccessTip"></span>
					<span class="sa-line sa-long animateSuccessLong"></span>
					<div class="sa-placeholder"></div>
					<div class="sa-fix"></div>
				  </div>
				</div>
			</div>
		</div>
	</div>
	
	<!-- Modal -->
	<div id="myModal" class="modal fade" role="dialog">
	  <div class="modal-dialog">

		<!-- Modal content-->
		<div class="modal-content">
		  <div class="modal-header">
			<h4 class="modal-title">Modal Header</h4>
			<button type="button" class="close" data-dismiss="modal">&times;</button>
		  </div>
		  <div class="modal-body">
			<p>Some text in the modal.</p>
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		  </div>
		</div>

	  </div>
	</div>
	</br>
    <footer class="py-5 bg-dark">
      <div class="container">
        <p class="m-0 text-center text-white">Copyright &copy; Easy Imgur Uploader 2018</p>
      </div>
      <!-- /.container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
	<script type="text/javascript" src="js/dropzone.js"></script>
	<script src="js/inflate.js"></script>
	<script src="js/z-worker.js"></script>
	<script src="js/zip.js"></script>
	
	<!-- Get Files -->
	<script type="text/javascript">
	zip.workerScriptsPath = 'js/';
	var images = [];
	var base64images = [];
	var error = "";
	async function SendImage(itt){
		if(document.getElementById("albumid").value){
			$("#ChooseOptions").hide();
			$("#SubmitCheck").show();
		}
		UploadToImgur(base64images[itt]);
		console.log("uploading...");
		
	}
	function getLength(arr){return Object.keys(arr).length;}
	async function Base64Images(num){
		var promise = getBase64(images[num]);
		var image = await promise;
		base64images[num] = image;
		if(getLength(base64images) == getLength(images)){
			SendImage(0);
		}
	}
	function getBase64(file, onLoadCallback) {
			return new Promise(function(resolve, reject) {
				var reader = new FileReader();
				reader.onload = function() { resolve(reader.result); };
				reader.onerror = reject;
				reader.readAsDataURL(file);
			});
		}
	$(document).ready(function() {
		if(window.location.toString().indexOf("?") == -1 && window.location.toString().indexOf("#") != -1)
		{
			window.location = window.location.toString().replace("#","?");
		}
		var dropzone = new Dropzone("div#dropzone", { url: "/", autoQueue: false, maxFilesize: 100});	
		var qs = getQueryStrings();
		var clientId = token || document.getElementById("clientid").value; // Your client Id
		var token = qs["access_token"] || clientId;
		
		$(".check_mark").hide();
		if(token){
			$("#LoadID").hide();
			$("#LoadCheck").show();
		}
		function Error(text){
			output = $(".modal-body p");
			output.value += text;
			console.log(output.value);
		}
		window.onerror = function(msg, url, linenumber) {
			Error('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber);
			return true;
		}
		function unzipUrl(dataURL, callback) {
		  // use a zip.BlobReader object to read zipped data stored into blob variable
		  zip.createReader(new zip.BlobReader(dataURL), function(zipReader) {
			// get entries from the zip file
			zipReader.getEntries(function(entries) {
			  // get data from the first file
			  console.log("Extracted File: " + entries);
			  for(i = 0; i < entries.length; i++){
					if(!entries[i].directory){
						entries[i].getData(new zip.BlobWriter(), function(blob) {
						// text contains the entry data as a String
						console.log("Blob: " + blob);
						images[images.length] = blob;
						// close the zip reader
						//reader.close(function() {
						  // onclose callback
						//});
					  }, function(current, total) {
						// onprogress callback
					  });
					}
				}
			});
		  }, onerror);
		}
		
		$("#Submit").click(function(){
			if(images.length > 0){
				for(i = 0; i < images.length; i++){
					Base64Images(i)
				}
			}
			}
		);
		dropzone.on("addedfile",function(file){
			if(this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0){
				console.log("failed");
				Error("failed to recieve file");
			}
			console.log("success");
			console.log("Zip File: " + file);
			$("#dropzone").hide();
			$("#FileCheck").show();
			unzipUrl(file);
		});
	});
		function getQueryStrings() { 
		  var assoc  = {};
		  var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
		  var queryString = location.search.substring(1); 
		  var keyValues = queryString.split('&'); 
		  for(var i in keyValues) { 
			var key = keyValues[i].split('=');
			if (key.length > 1) {
			  assoc[decode(key[0])] = decode(key[1]);
			}
		  } 
		  return assoc; 
		} 
		function Authorize(){
			clientId = document.getElementById('clientid').value;
			window.location = 'https://api.imgur.com/oauth2/authorize?client_id=' + clientId + '&response_type=token';
		}
		var imagenum = 1;
		function UploadToImgur(file) {			
			var albumId = document.getElementById("albumid").value; // Your owned album id
			var qs = getQueryStrings();
			var clientId = token || document.getElementById("clientid").value; // Your client Id
			var token = qs["access_token"] || clientId;
			if(!token){
				Error("The autorization process either failed or was canceled");
			}
			var form = new FormData();
			form.append("image", file.toString().replace("data:;base64",""));
			form.append("album", albumId);
			var settings = {
			  "async": true,
			  "crossDomain": true,
			  "url": "https://api.imgur.com/3/image",
			  "method": "POST",
			  "headers": {
				"Authorization": "Bearer " + token
			  },
			  "processData": false,
			  "contentType": false,
			  "mimeType": "multipart/form-data",
			  "data": form
			}
			$.ajax(settings).done(function (response) {
				Error(response);
				if(imagenum < images.length){
					imagenum++;
					SendImage(imagenum);
				}
			});
			}
	</script>
  </body>

</html>
